# Database Models & Migrations Guide

## Overview

This guide covers the 8 core models, migrations, factories, and seeders for the Molunzaka streaming platform.

## Models & Relationships

### 1. **User** â†” Profile, Subscription, Video, WatchHistory
- Platform users with authentication
- Can have multiple profiles
- Can have multiple subscriptions
- Can upload videos
- Can have watch history

### 2. **Plan**
- Subscription plans (Basic, Standard, Premium)
- Defines features: HD, 4K, offline download, ad-free
- Has many subscriptions

### 3. **Subscription** â†” User, Plan
- Links users to plans
- Tracks subscription lifecycle
- Manages renewal and cancellation

### 4. **Profile** â†” User, WatchHistory
- Child accounts per user
- Independent watch history
- Personal preferences

### 5. **Video** â†” User, VideoFile, Subtitle, WatchHistory
- Main content model
- Multiple quality renditions
- Multilingual subtitles
- Tracks views and ratings

### 6. **VideoFile** â†” Video, VideoRendition
- Uploaded video source
- Stores processing status
- Linked to renditions

### 7. **VideoRendition** â†” VideoFile
- Encoded quality levels (360p, 480p, 720p, 1080p)
- Different codecs and bitrates
- Tracks encoding status

### 8. **Subtitle** â†” Video
- Video captions/subtitles
- Multiple languages
- Auto-generated or manual

### 9. **WatchHistory** â†” User, Profile, Video
- User viewing activity
- Progress tracking
- Device information

---

## Database Migrations

All migrations are in `database/migrations/`:

```
0001_01_01_000000_create_users_table.php
0001_01_01_000001_create_profiles_table.php
0001_01_01_000002_create_plans_table.php
0001_01_01_000003_create_subscriptions_table.php
0001_01_01_000004_create_videos_table.php
0001_01_01_000005_create_video_files_table.php
0001_01_01_000006_create_video_renditions_table.php
0001_01_01_000007_create_subtitles_table.php
0001_01_01_000008_create_watch_histories_table.php
```

### Key Features

- âœ… Proper foreign keys with cascading deletes
- âœ… Indexes on frequently queried columns
- âœ… Unique constraints for data integrity
- âœ… JSON columns for flexible metadata
- âœ… Timestamps for created_at/updated_at
- âœ… Status tracking for processing workflows
- âœ… Full-text search indexes for titles

---

## Eloquent Models

All models are in `app/Models/` with:

- âœ… PHPDoc comments
- âœ… Type hints for properties and relationships
- âœ… `$fillable` for mass assignment
- âœ… `$casts` for type casting
- âœ… Helper methods (e.g., `isActive()`, `canRenew()`)
- âœ… Relationship definitions

### Model Files

```
app/Models/User.php
app/Models/Plan.php
app/Models/Profile.php
app/Models/Subscription.php
app/Models/Video.php
app/Models/VideoFile.php
app/Models/VideoRendition.php
app/Models/Subtitle.php
app/Models/WatchHistory.php
```

---

## Model Factories

All factories in `database/factories/` for testing:

```
UserFactory.php           â†’ Create test users (admin, creator, regular)
PlanFactory.php           â†’ Create test subscription plans
ProfileFactory.php        â†’ Create user profiles
SubscriptionFactory.php   â†’ Create subscriptions (active, cancelled, expired)
VideoFactory.php          â†’ Create videos (published, featured, unpublished)
VideoFileFactory.php      â†’ Create video files (processing, failed, completed)
VideoRenditionFactory.php â†’ Create encoded quality levels (360p, 480p, 720p, 1080p)
SubtitleFactory.php       â†’ Create subtitles (auto-generated, verified)
WatchHistoryFactory.php   â†’ Create watch history (completed, in-progress)
```

### Factory States

Each factory includes state methods:

```php
// User states
User::factory()->admin()->create()
User::factory()->creator()->create()
User::factory()->inactive()->create()

// Plan states
Plan::factory()->inactive()->create()

// Profile states
Profile::factory()->primary()->create()
Profile::factory()->inactive()->create()

// Subscription states
Subscription::factory()->cancelled()->create()
Subscription::factory()->expired()->create()

// Video states
Video::factory()->published()->create()
Video::factory()->featured()->create()
Video::factory()->unpublished()->create()

// VideoFile states
VideoFile::factory()->processing()->create()
VideoFile::factory()->failed()->create()

// VideoRendition states
VideoRendition::factory()->hd()->create()        // 720p
VideoRendition::factory()->fullHd()->create()    // 1080p

// Subtitle states
Subtitle::factory()->autoGenerated()->create()
Subtitle::factory()->unverified()->create()

// WatchHistory states
WatchHistory::factory()->completed()->create()
WatchHistory::factory()->inProgress()->create()
```

---

## Database Seeders

All seeders in `database/seeders/`:

```
DatabaseSeeder.php       â†’ Main orchestrator
PlanSeeder.php           â†’ Creates 3 active + 2 inactive plans
UserSeeder.php           â†’ Creates admin, test user, creator, 5 random users
SubscriptionSeeder.php   â†’ Links users to plans
ProfileSeeder.php        â†’ Creates 1-2 profiles per user
VideoSeeder.php          â†’ Creates videos for creators
VideoFileSeeder.php      â†’ Links files to videos
VideoRenditionSeeder.php â†’ Creates 2-4 renditions per file
SubtitleSeeder.php       â†’ Adds subtitles to videos
WatchHistorySeeder.php   â†’ Creates viewing history
```

---

## Running Migrations & Seeds

### Option 1: Fresh Migration with Seed (Clears Database)

```bash
docker compose exec app php artisan migrate:fresh --seed
```

**Expected Output:**
```
Migrating: 0001_01_01_000000_create_users_table
Migrated: 0001_01_01_000000_create_users_table (XXms)
Migrating: 0001_01_01_000001_create_profiles_table
Migrated: 0001_01_01_000001_create_profiles_table (XXms)
...
Seeding: PlanSeeder
Seeded: PlanSeeder (XXms)
Seeding: UserSeeder
Seeded: UserSeeder (XXms)
...
Database seeding completed successfully.
```

### Option 2: Run Migrations Only

```bash
docker compose exec app php artisan migrate
```

### Option 3: Run Seeds Only (Database Must Exist)

```bash
docker compose exec app php artisan db:seed
```

### Option 4: Seed Specific Seeder

```bash
docker compose exec app php artisan db:seed --class=PlanSeeder
```

### Option 5: Rollback & Migrate

```bash
docker compose exec app php artisan migrate:rollback
docker compose exec app php artisan migrate
```

---

## Sample Data Created

### Users Created

- 1 Admin: `admin@molunzaka.test` / password
- 1 Test User: `user@molunzaka.test` / password
- 1 Creator: `creator@molunzaka.test` / password
- 5 Random users

### Plans Created

| Name | Price | Max Profiles | HD | 4K | Offline | Ad-Free |
|------|-------|--------------|----|----|---------|---------|
| Basic | $5.99 | 1 | âœ— | âœ— | âœ— | âœ— |
| Standard | $9.99 | 2 | âœ“ | âœ— | âœ“ | âœ— |
| Premium | $15.99 | 4 | âœ“ | âœ“ | âœ“ | âœ“ |
| + 2 inactive | - | - | - | - | - | - |

### Subscriptions Created

- 1 per user (active or expired)
- Random cancelled subscriptions

### Profiles Created

- 1-2 per user
- 1 marked as primary

### Videos Created

- 3-5 published per creator
- 1-2 featured per creator
- 1-3 unpublished per creator
- Multiple random users get videos

### Video Files

- 1-2 files per video
- Status: completed

### Video Renditions

- 2-4 renditions per file
- Qualities: 360p, 480p, 720p, 1080p

### Subtitles

- 1-3 languages per video
- Languages: English, Spanish, French, German, Italian

### Watch History

- 5-10 entries per user profile
- 70% completed, 30% in progress

---

## Testing

### Run All Tests

```bash
docker compose exec app php artisan test
```

### Run Specific Test

```bash
docker compose exec app php artisan test tests/Unit/Models/UserTest.php
```

### Run with Coverage

```bash
docker compose exec app php artisan test --coverage
```

### Test Files Created

```
tests/Unit/Models/UserTest.php
tests/Unit/Models/SubscriptionTest.php
tests/Unit/Models/VideoTest.php
tests/Unit/Models/WatchHistoryTest.php
```

---

## Common Commands

### Check Migration Status

```bash
docker compose exec app php artisan migrate:status
```

### Verify Data in Database

```bash
docker compose exec app php artisan tinker

>>> User::count()
=> 8

>>> Video::count()
=> 12

>>> Subscription::count()
=> 8

>>> exit
```

### View Table Structure

```bash
docker compose exec app php artisan db:table users
```

### Check Relationships

```bash
docker compose exec app php artisan tinker

>>> $user = User::with('profiles', 'subscriptions', 'videos')->first()
>>> $user->profiles
>>> $user->subscriptions
>>> exit
```

---

## Model Methods

### User

```php
$user->primaryProfile()          // Get primary profile
$user->activeSubscription()      // Get active subscription
$user->isCreator()              // Check if creator
$user->isAdmin()                // Check if admin
```

### Subscription

```php
$subscription->isActive()       // Check if currently active
$subscription->canRenew()       // Check if can renew
```

### Video

```php
$video->incrementViews()        // Add to view count
$video->addRating($score)       // Add rating
```

### VideoFile

```php
$videoFile->isProcessing()      // Check if processing
$videoFile->isComplete()        // Check if done
$videoFile->isFailed()          // Check if failed
```

### VideoRendition

```php
$rendition->isProcessing()      // Check if processing
$rendition->isComplete()        // Check if done
```

### WatchHistory

```php
$history->updateProgress()      // Calculate progress & completion
```

---

## File Structure

```
database/
â”œâ”€â”€ migrations/
â”‚   â”œâ”€â”€ 0001_01_01_000000_create_users_table.php
â”‚   â”œâ”€â”€ 0001_01_01_000001_create_profiles_table.php
â”‚   â”œâ”€â”€ 0001_01_01_000002_create_plans_table.php
â”‚   â”œâ”€â”€ 0001_01_01_000003_create_subscriptions_table.php
â”‚   â”œâ”€â”€ 0001_01_01_000004_create_videos_table.php
â”‚   â”œâ”€â”€ 0001_01_01_000005_create_video_files_table.php
â”‚   â”œâ”€â”€ 0001_01_01_000006_create_video_renditions_table.php
â”‚   â”œâ”€â”€ 0001_01_01_000007_create_subtitles_table.php
â”‚   â””â”€â”€ 0001_01_01_000008_create_watch_histories_table.php
â”œâ”€â”€ factories/
â”‚   â”œâ”€â”€ UserFactory.php
â”‚   â”œâ”€â”€ PlanFactory.php
â”‚   â”œâ”€â”€ ProfileFactory.php
â”‚   â”œâ”€â”€ SubscriptionFactory.php
â”‚   â”œâ”€â”€ VideoFactory.php
â”‚   â”œâ”€â”€ VideoFileFactory.php
â”‚   â”œâ”€â”€ VideoRenditionFactory.php
â”‚   â”œâ”€â”€ SubtitleFactory.php
â”‚   â””â”€â”€ WatchHistoryFactory.php
â””â”€â”€ seeders/
    â”œâ”€â”€ DatabaseSeeder.php
    â”œâ”€â”€ PlanSeeder.php
    â”œâ”€â”€ UserSeeder.php
    â”œâ”€â”€ SubscriptionSeeder.php
    â”œâ”€â”€ ProfileSeeder.php
    â”œâ”€â”€ VideoSeeder.php
    â”œâ”€â”€ VideoFileSeeder.php
    â”œâ”€â”€ VideoRenditionSeeder.php
    â”œâ”€â”€ SubtitleSeeder.php
    â””â”€â”€ WatchHistorySeeder.php

app/Models/
â”œâ”€â”€ User.php
â”œâ”€â”€ Plan.php
â”œâ”€â”€ Profile.php
â”œâ”€â”€ Subscription.php
â”œâ”€â”€ Video.php
â”œâ”€â”€ VideoFile.php
â”œâ”€â”€ VideoRendition.php
â”œâ”€â”€ Subtitle.php
â””â”€â”€ WatchHistory.php

tests/Unit/Models/
â”œâ”€â”€ UserTest.php
â”œâ”€â”€ SubscriptionTest.php
â”œâ”€â”€ VideoTest.php
â””â”€â”€ WatchHistoryTest.php
```

---

## Quick Start

1. **Build and start containers:**
   ```bash
   docker compose build && docker compose up -d
   ```

2. **Install dependencies:**
   ```bash
   docker compose exec app composer install
   ```

3. **Generate app key:**
   ```bash
   docker compose exec app php artisan key:generate
   ```

4. **Run migrations with seed:**
   ```bash
   docker compose exec app php artisan migrate:fresh --seed
   ```

5. **Verify data:**
   ```bash
   docker compose exec app php artisan tinker
   >>> User::count()
   >>> Video::count()
   >>> exit
   ```

6. **Run tests:**
   ```bash
   docker compose exec app php artisan test
   ```

---

## Next Steps

1. Create API Controllers for CRUD operations
2. Create Services for business logic
3. Create Queue Jobs for video processing
4. Create Filament Admin Resources
5. Create API Routes with authorization
6. Add more comprehensive integration tests

---

**Database setup complete!** ðŸš€
